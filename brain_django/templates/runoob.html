<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>基于EEG与人工智能的睡眠健康评估系统 V1.0</title>
  {% load static %}
  <link rel="shortcut icon" href="{% static 'images/favicon.ico' %}" type="image/x-icon">
  <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
  <script src="https://unpkg.com/vue@2/dist/vue.js"></script>
  <script src="https://unpkg.com/element-ui/lib/index.js"></script>
  <style>
    /* 全局样式 */
    body { 
      margin: 0;
    }
    .app-container {
      font-family: 'Microsoft YaHei', sans-serif;
      margin: 0;
      padding: 20px;
      /* background: linear-gradient(135deg, #0a0a2a, #001f6e); */
      /* background: linear-gradient(to right, rgb(15, 12, 41), rgb(48, 43, 99), rgb(36, 36, 62)); */
      background: linear-gradient(to right, rgba(0, 0, 70, 0.3), rgba(28, 181, 224, 0.3)), url('{% static "images/背景鲸鱼.jpg" %}');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      background-attachment: fixed;
      min-height: 100vh;
      color: #fff;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
    }

    .logo-container {
      width: 120px;
      height: 120px;
      margin: 50px auto 0px auto;
      display: block;
    }

    .logo-container img {
      width: 120px;
      height: auto;
      border-radius: 50%;
      box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
    }

    .title {
      color: #ffd000;
      font-size: 1.8rem;
      margin: 10px 0;
      text-shadow: 0 0 10px rgba(0, 255, 255, 0.7);
    }

    .subtitle {
      color: #99ccff;
      font-size: 0.9rem;
      margin-top: 5px;
    }

    .status-bar {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 20px;
      font-size: 0.9rem;
    }

    .status-item {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 20px;
    }

    .el-icon-circle-check {
      color: #00ff00;
      animation: pulse 2s infinite;
      
    }

    .el-icon-circle-cross {
      color: #ff0000;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .button-group {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-bottom: 20px;
      
    }
    .custom-input input {
      margin-top: 5px;
      border: 2px solid #00ffff !important;
      box-shadow: 0 0 10px rgba(0, 255, 255, 0.7) !important;
      border-radius: 8px !important;
      background-color: rgba(51, 128, 158, 0.8) !important;
      color: #fff !important;
    }
    .el-button {
      border: 1px solid #00ffff;
      border-radius: 8px;
      padding: 10px 20px;
      box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
      transition: all 0.3s ease;
      background: transparent;
      color: #00ffff;
      font-size: 20px;
    }
    #scann_button{
      margin-top: 8px;
      font-size: 16px;
      
    }

    .el-button:hover {
      transform: scale(1.05);
      box-shadow: 0 0 20px rgba(0, 255, 255, 0.8);
    }

    .el-button[type="primary"] {
      background: transparent;
      color: #00ffff;
    }

    .el-button[type="success"] {
      background: transparent;
      color: #00ff00;
    }

    .el-button[type="warning"] {
      background: transparent;
      color: #ffcc00;
    }

    .el-button[type="info"] {
      background: transparent;
      color: #00ccff;
    }

    .main-content {  
      margin-left: 12.5%;
      width: 75%;
      display: flex;
      gap: 20px;
    }
        /* 固定标签页内容区域 */
    .tab-content-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 400px; /* 设置最小高度 */
      max-height: 600px; /* 设置最大高度 */
      height: 500px; /* 设置固定高度 */
    }
    
    .tab-pane-content {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      background: rgba(0, 20, 40, 0.6);
      border-radius: 8px;
      border: 1px solid #00aaff;
      box-shadow: 0 0 10px rgba(51, 142, 253, 0.301);
    }
    .sidebar {
      width: 350px;
      height: 700;
      background: rgba(47, 99, 242, 0.297);
      border: 1px solid #00ffff;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 0 20px rgba(0, 255, 255, 0.2);
    }

    .card {
      margin-bottom: 20px;
      border-bottom: 1px solid #00ffff;
      padding-bottom: 16px;
    }

    .card h3 {
      margin-top: 0;
      font-size: 1rem;
      color: #00ffff;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .form-group {
      margin: 10px 0;
    }

    .status-info {
      margin-top: 10px;
      font-size: 0.9rem;
      color: #99ccff;
    }

    .data-status {
      padding: 10px;
      background: rgba(104, 104, 111, 0.506);
      border-radius: 4px;
      margin-top: 10px;
      color: #00ffff;
    }

    .history-file {
      margin-top: 10px;
      font-size: 0.9rem;
      color: #99ccff;
    }

    /* 主内容 */
    .main-panel {
      flex: 1;
      background: rgba(27, 27, 82, 0.5);
      border: 1px solid #00ffff;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 0 20px rgba(63, 109, 158, 0.2);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .main-panel .el-tabs {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .main-panel .el-tabs__content {
      flex: 1;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .main-panel .el-tab-pane {
      flex: 1;
      overflow-y: auto;
      height: 100%;
      display: flex;
      flex-direction: column;
    }
 
    .data-flow {
      text-align: center;
      padding: 40px;
      color: #99ccff;
      font-size: 1rem;
      flex: 1;
      overflow-y: auto;
    }

    .placeholder {
      height: 100%;
      overflow-y: auto;
      text-align: left;
      white-space: pre-wrap;
      color: #00ffff;
      font-family: monospace;
      line-height: 1.5;
      background: rgba(28, 48, 74, 0.345);
      padding: 10px;
      border-radius: 8px;
      flex: 1;
    }
    /* 主内容 */

    .clear-log-btn {
      text-align: right;
      margin-top: 10px;
    }

    .footer {
      text-align: center;
      margin-top: 30px;
      color: #99ccff;
      font-size: 0.8rem;
      text-shadow: 0 0 5px rgba(0, 255, 255, 0.5);
    }

    /* 标签页样式 */
    .el-tabs__item {
      color: #99ccff !important;
      font-weight: bold;
    }

    .el-tabs__item.is-active {
      color: #00ffff !important;
      border-bottom: 2px solid #00ffff;
    }

    .el-tabs__nav {
      border-bottom: none;
    }
  </style>
</head>
<body>
  <div id="app" class="app-container">
    <!-- 头部 -->
    <header class="header">
      <div class="logo-container">
        <img src="{% static 'images/logo.jpg' %}" alt="云梦泽 - Yun Meng Ze">
      </div>
      <h1 class="title">基于EEG与人工智能的睡眠健康评估系统 V2.0</h1>
      <p class="subtitle">实时采集 · 本地存储 · 智能分析</p>
    </header>

    <!-- 状态指示 -->
    {% verbatim %}
    <div class="status-bar">
      <span class="status-item"><i class="el-icon-circle-check" style="color: green;"></i> 后端: 已连接</span>
      <span class="status-item"><i :class="isConnected ? 'el-icon-circle-check' : 'el-icon-circle-cross'" :style="{color: isConnected ? 'green' : 'red'}"></i> 设备: {{ deviceStatus }}</span>
      <span class="status-item"><i :class="isRecording ? 'el-icon-circle-check' : 'el-icon-circle-cross'" :style="{color: isRecording ? 'green' : 'red'}"></i> 数据: {{ isRecording ? '正在记录' : '未连接' }}</span>
      <span class="status-item"><i class="el-icon-circle-cross" style="color: red;"></i> API: 未连接</span>
    </div>

    <!-- 操作按钮 -->
    <div class="button-group">
      <el-button  type="primary" @click="connectDevice" >连接设备</el-button>
      <el-button type="success" @click="startRecording">{{ isRecording ? '停止记录' : '开始记录' }}</el-button>
      <el-button type="warning" @click="analyzeData">分析数据</el-button>
      <el-button type="info" @click="importData">导入数据</el-button>
      <el-button type="text" @click="testBackend">测试后端连接</el-button>
    </div>

    <!-- 主体内容 -->
    <div class="main-content">
      <!-- 左侧侧边栏 -->
      <div class="sidebar">
        <!-- 设备连接 -->
        <div class="card">
          <h3><i class="el-icon-mobile-phone"></i> 设备连接</h3>
          <div class="form-group">
            <label>蓝牙设备地址</label>
            <el-input class="custom-input" v-model="deviceAddress" placeholder="例如: JDY-18"></el-input>
            <el-button id="scann_button" type="primary" size="small" @click="scanDevices">扫描</el-button>
          </div>
          <div class="status-info">
            <p>连接状态: <span style="color: red;">{{deviceStatus}}</span></p>
            <p>信号质量: <span>-- /200</span></p>
          </div>
        </div>

        <!-- 数据保存 -->
        
        <div class="card">
          <h3><i class="el-icon-document"></i> 数据保存</h3>
          <div class="data-status">
            <p>{{ dataStatus }}</p>
          </div>
        </div>
        
        <!-- <div class="card">
          <h3><i class="el-icon-document"></i> 最新记录</h3>
          <div class="data-status">
            {% if latest_record %}
              <p>记录名称: {{ latest_record.name }}</p>
              <p>记录ID: {{ latest_record.recording_id }}</p>
              <p>开始时间: {{ latest_record.start_time }}</p>
              <p>结束时间: {{ latest_record.end_time }}</p>
              <p>数据点数: {{ latest_record.data_count }}</p>
            {% else %}
              <p>暂无记录</p>
            {% endif %}
          </div>
        </div> -->


        <!-- 分析配置 -->
        <div class="card">
          <h3><i class="el-icon-setting"></i> 分析配置</h3>
          <div class="form-group">
            <label>API密钥</label>
            <el-input  class="custom-input" v-model="apiKey" placeholder="请输入API密钥"></el-input>
          </div>
          <el-button type="primary" size="small" @click="testAPI">测试API</el-button>
          <div class="history-file">
            <p>历史数据文件</p>
            <p style="color: #99ccff;">暂无历史数据</p>
          </div>
        </div>
      </div>

      <!-- 右侧主内容区 -->
      <div class="main-panel">
        <el-tabs v-model="activeTab">
          <el-tab-pane label="实时数据" name="realtime">
            <div class="tab-content-container">
              <div class="tab-pane-content">
                <div class="data-flow">
                  <i class="el-icon-info"></i>
                  <p>未连接设备，请先连接设备开始采集数据</p>
                </div>
              </div>
            </div>
          </el-tab-pane>
          <el-tab-pane label="分析报告" name="report">
            <div class="tab-content-container">
              <div class="tab-pane-content">
                <div class="placeholder" v-if="!reportContent">分析报告内容将显示在此处</div>
                <div v-else class="report-content" v-html="reportContent"></div>
              </div>
            </div>
          </el-tab-pane>
          <el-tab-pane label="系统日志" name="log">
            <div class="tab-content-container">
              <div class="tab-pane-content">
                <div class="placeholder" v-text="logContent || '系统日志将显示在此处'"></div>
              </div>
            </div>
          </el-tab-pane>
        </el-tabs>
        <div class="clear-log-btn">
          <el-button type="text" @click="clearLog">清空日志</el-button>
        </div>
      </div>
    </div>

    <!-- 底部 -->
    <footer class="footer">
      基于EEG与人工智能的睡眠健康评估系统 V1.0 | 本地数据安全存储 | 支持CSV/Excel数据分析
    </footer>
  </div>

  <script>


    new Vue({
      el: '#app',
      data: {
        deviceAddress: '',
        apiKey: '51e09aa5-d2dd-41ab-bf91-51ef798844e7',
        activeTab: 'realtime',
        websocket: null,
        isConnected: false,
        isRecording: false,
        deviceStatus: '未连接',
        signalQuality: '-- /200',
        dataStatus: '未保存数据',
        logContent: '',
        reportContent: '',
        historyFiles: [],
        importedFileName: '',
        currentFilePath: '',
        // latestRecord: JSON.parse('{% if latest_record %}{{ latest_record|escapejs }}{% else %}null{% endif %}'),
      },
      methods: {
        /**
         * 连接设备函数
         * 建立与后端WebSocket服务器的连接，用于传输EEG数据
         * 根据当前协议（HTTP或HTTPS）自动选择ws://或wss://协议
         */
        connectDevice: function() {
          // 检查设备是否已经连接
          if (this.isConnected) {
            this.$message.info('设备已连接');
            return;
          }
          
          try {
            // 使用绝对路径，避免协议问题
            const wsUrl = 'ws://' + window.location.host + '/ws/eeg/';
            console.log('尝试连接到WebSocket:', wsUrl); // 添加调试日志
            
            this.websocket = new WebSocket(wsUrl);
            
            // 连接成功回调
            this.websocket.onopen = () => {
              console.log('WebSocket连接成功'); // 添加调试日志
              this.isConnected = true;
              this.deviceStatus = '已连接';
              this.$message.success('设备连接成功');
              // 更新页面上的连接状态文本
              const statusElement = document.querySelector('.status-info span');
              if (statusElement) {
                statusElement.style.color = 'green';
                statusElement.textContent = '已连接';
              }
            };
            
            // 接收消息回调 - 这里是处理后端返回消息的关键部分
            this.websocket.onmessage = (event) => {
              const data = JSON.parse(event.data);
              this.handleWebSocketMessage(data);
            };
            
            // 连接关闭回调
            this.websocket.onclose = () => {
              this.isConnected = false;
              this.isRecording = false;
              this.deviceStatus = '未连接';
              this.$message.info('设备连接已断开');
            };
            
            // 连接错误回调
            this.websocket.onerror = (error) => {
              console.error('WebSocket连接错误:', error); // 添加调试日志
              this.$message.error('连接发生错误: ' + error.message);
              // 更新页面上的连接状态文本
              const statusElement = document.querySelector('.status-info span');
              if (statusElement) {
                statusElement.style.color = 'red';
                statusElement.textContent = '连接错误';
              }
            };
          } catch (error) {
            console.error('WebSocket连接异常:', error); // 添加调试日志
            this.$message.error('连接失败: ' + error.message);
          }
        },
        
                /**
         * 加载分析报告
         * 从服务器获取并显示分析报告
         * @param {string} filename - 报告文件名
         */
        loadReport: function(filename) {
          // 确保文件名不为空
          if (!filename) {
            this.$message.error('报告文件名为空');
            return;
          }
          
          // 构造报告URL
          const reportUrl = `/reports/${filename}`;
          
          fetch(reportUrl)
          .then(response => {
            if (response.ok) {
              return response.text();
            } else {
              throw new Error('报告文件不存在');
            }
          })
          .then(html => {
            this.reportContent = html;
            this.activeTab = 'report';
          })
          .catch(error => {
            this.$message.error('加载报告失败: ' + error.message);
          });
        },

           /**
         * 开始/停止记录数据
         * 切换记录状态并控制EEG数据发送
         */
        startRecording: function() {
          // 切换记录状态
          this.isRecording = !this.isRecording;
          
          if (this.isRecording) {
            // 开始记录
            if (!this.isConnected) {
              this.$message.warning('请先连接设备');
              this.isRecording = false;
              return;
            }
            
            this.$message.success('开始记录数据');
            // 开始发送EEG数据
            this.sendEEGData();
          } else {
            // 停止记录
            this.$message.info('已停止记录数据');
            this.dataStatus = '记录已停止';
          }
        },

        /**
         * 导入数据函数
         * 允许用户上传EEG数据文件进行分析
         */
        
        /**
         * 发送EEG数据
         * 定期生成并发送模拟EEG数据到后端
         */
        sendEEGData: function() {
          // 检查是否应该继续发送数据
          if (!this.isRecording || !this.isConnected) return;
          
          // 构造EEG数据对象
          const eegData = {
            type: 'eeg_data',
            timestamp: new Date().toISOString(),
            data: this.generateMockEEGData()
          };
          
          try {
            // 发送数据到后端
            this.websocket.send(JSON.stringify(eegData));
            this.dataStatus = '正在记录数据...';
          } catch (error) {
            this.$message.error('发送数据失败: ' + error.message);
          }
          
          // 如果仍在记录状态，1秒后再次发送数据
          if (this.isRecording) {
            setTimeout(() => this.sendEEGData(), 1000);       //递推，除非停止记录状态，否则一直在执行sendEEGData
          }
        },
        
        /**
         * 生成模拟EEG数据
         * 创建包含各个脑电波频段的模拟数据
         * @returns {string} 格式化的EEG数据字符串
         */
        generateMockEEGData: function() {
          const bands = ['Delta', 'Theta', 'Alpha', 'Beta', 'Gamma'];
          const data = bands.map(band => {
            return band + ' ' + Math.floor(Math.random() * 100);
          });
          return data.join(' ');
        },

        /**
         * 分析数据函数
         * 请求后端对已记录的EEG数据进行分析
         */
        analyzeData: function() {
          // 如果有导入的文件，分析导入的文件
          if (this.importedFileName && this.currentFilePath) {
            this.analyzeExistingFile(this.currentFilePath);
            return;
          }
          
          // 检查设备是否已连接
          if (!this.isConnected) {
            this.$message.warning('请先连接设备或导入数据文件');
            return;
          }
          
          // 构造分析请求对象
          const analysisRequest = {
            type: 'request_analysis',
            api_key: this.apiKey
          };
          
          try {
            // 发送分析请求到后端
            this.websocket.send(JSON.stringify(analysisRequest));
            this.$message.info('正在分析数据...');
          } catch (error) {
            this.$message.error('发送分析请求失败: ' + error.message);
          }
        },
        
        /**
         * 分析已存在的文件
         * 对导入的数据文件请求分析
         * @param {string} filePath - 文件路径
         */
        analyzeExistingFile: function(filePath) {
          fetch('/api/analyze-existing-data/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              file_path: filePath,
              api_key: this.apiKey
            })
          })
          .then(response => response.json())
          .then(data => {
            if (data.status === 'success') {
              this.$message.success(data.message);
              this.logContent += `[${new Date().toLocaleTimeString()}] ${data.message}\n`;
              this.loadReport(data.report_filename);
            } else {
              this.$message.error(data.message);
              this.logContent += `[${new Date().toLocaleTimeString()}] 分析失败: ${data.message}\n`;
            }
          })
          .catch(error => {
            this.$message.error('分析请求失败: ' + error.message);
            this.logContent += `[${new Date().toLocaleTimeString()}] 分析请求失败: ${error.message}\n`;
          });
        },
        


        /**
         * 导入数据函数
         * 允许用户上传EEG数据文件进行分析
         */
        importData: function() {
          // 创建文件输入元素
          const fileInput = document.createElement('input');
          fileInput.type = 'file';
          fileInput.accept = '.csv,.xlsx,.xls,.txt';
          
          fileInput.onchange = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            
            // 创建表单数据
            const formData = new FormData();
            formData.append('file', file);
            
            // 发送文件到后端
            fetch('/api/import-eeg-data/', {
              method: 'POST',
              body: formData
            })
            .then(response => response.json())
            .then(data => {
              if (data.status === 'success') {
                this.$message.success(data.message);
                this.logContent += `[${new Date().toLocaleTimeString()}] ${data.message}\n`;
                this.dataStatus = `已导入: ${file.name}`;
                this.importedFileName = file.name;
                this.currentFilePath = data.file_path;
                
                // 如果设备已连接，通知后端有新导入的数据
                if (this.isConnected) {
                  const importNotification = {
                    type: 'imported_data',
                    fileName: file.name,
                    filePath: data.file_path
                  };
                  this.websocket.send(JSON.stringify(importNotification));
                }
              } else {
                this.$message.error(data.message);
                this.logContent += `[${new Date().toLocaleTimeString()}] 导入失败: ${data.message}\n`;
              }
            })
            .catch(error => {
              this.$message.error('文件上传失败: ' + error.message);
              this.logContent += `[${new Date().toLocaleTimeString()}] 文件上传失败: ${error.message}\n`;
            });
          };
          
          fileInput.click();
        },
        
        /**
         * 测试后端连接
         * 验证与后端服务器的连接状态
         */
        testBackend: function() {
          this.$message.success('后端连接正常');
        },
        
        /**
         * 检查蓝牙支持情况
         * 检测浏览器是否支持Web Bluetooth API以及运行环境是否满足要求
         * @returns {boolean} 是否支持蓝牙功能
         */
        checkBluetoothSupport: function() {
          // 检查各种支持条件
          const supportInfo = {
            bluetooth: !!navigator.bluetooth,  // 浏览器是否支持Web Bluetooth API
            secureContext: window.isSecureContext,  // 是否在安全上下文中运行
            https: window.location.protocol === 'https:',  // 是否使用HTTPS协议
            localhost: window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1',  // 是否在本地环境运行
            chrome: /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor)  // 是否为Chrome浏览器
          };
          
          console.log('环境信息:', supportInfo);
          
          // 检查Web Bluetooth API支持情况
          if (!supportInfo.bluetooth) {
            let message = '您的浏览器不支持Web Bluetooth API。';
            if (!supportInfo.chrome) {
              message += '建议使用最新版Google Chrome浏览器。';
            } else if (!supportInfo.secureContext) {
              if (!supportInfo.https && !supportInfo.localhost) {
                message += 'Web Bluetooth需要HTTPS环境或本地环境(localhost)。';
              } else {
                message += '请检查浏览器设置或使用支持的浏览器。';
              }
            }
            this.$message.warning(message);
            return false;
          }
          
          // 检查安全上下文要求
          if (!supportInfo.secureContext) {
            this.$message.warning('Web Bluetooth需要安全环境（HTTPS或localhost）。');
            return false;
          }
          
          return true;
        },

        /**
         * 扫描蓝牙设备
         * 使用Web Bluetooth API扫描附近的蓝牙设备
         */
        scanDevices: function() {
          // 检查蓝牙支持
          if (!this.checkBluetoothSupport()) {
            return;
          }
         
          this.$message.info('正在扫描蓝牙设备...');
          console.log('开始扫描设备...');
          // 请求扫描蓝牙设备
          navigator.bluetooth.requestDevice({
            acceptAllDevices: true,
            optionalServices: [
              'battery_service',
              'generic_access',
              'device_information'
            ]
          })
          .then(device => {
            this.$message.success(`找到设备: ${device.name}`);
            this.deviceAddress = device.id;
            return device.gatt.connect();
          })
          .then(server => {
            this.$message.success('蓝牙设备配对成功');
          })
          .catch(error => {
            this.$message.error(`扫描失败: ${error.message}`);
          });
        },
        
        /**
         * 连接蓝牙设备
         * 通过Web Bluetooth API连接指定的蓝牙EEG设备
         */
        connectBluetoothDevice: function() {
          // 检查浏览器是否支持蓝牙
          if (!this.checkBluetoothSupport()) {
            return;
          }
          
          // 检查设备是否已经连接
          if (this.isConnected) {
            this.$message.info('设备已连接');
            return;
          }
          
          // 请求连接蓝牙设备
          navigator.bluetooth.requestDevice({
            filters: [{namePrefix: this.deviceAddress}],
            optionalServices: ['heart_rate'] // 根据实际设备修改
          })
          .then(device => {
            this.$message.success(`找到设备: ${device.name}`);
            return device.gatt.connect();
          })
          .then(server => {
            // 保存服务器连接用于后续操作
            this.bluetoothServer = server;
            this.isConnected = true;
            this.deviceStatus = '已连接';
            this.$message.success('蓝牙设备连接成功');
            
            // 如果需要开始记录数据
            if (this.isRecording) {
              this.startBluetoothDataStreaming();
            }
          })
          .catch(error => {
            this.$message.error(`连接失败: ${error.message}`);
          });
        },
        
        /**
         * 启动蓝牙数据流
         * 启动从蓝牙设备接收数据的流
         */
        startBluetoothDataStreaming: function() {
          // 检查蓝牙设备是否已连接
          if (!this.bluetoothServer) {
            this.$message.error('蓝牙设备未连接');
            return;
          }
          
          // 这里需要根据实际设备的GATT服务和特征来实现
          // 以下是一个示例实现
          this.bluetoothServer.getPrimaryService('heart_rate')
          .then(service => {
            return service.getCharacteristic('heart_rate_measurement');
          })
          .then(characteristic => {
            // 开始监听数据变化
            characteristic.addEventListener('characteristicvaluechanged', (event) => {
              // 处理接收到的蓝牙数据
              this.handleBluetoothData(event.target.value);
            });
            
            // 启用通知
            return characteristic.startNotifications();
          })
          .then(() => {
            this.$message.success('开始接收蓝牙数据');
          })
          .catch(error => {
            this.$message.error(`数据流启动失败: ${error.message}`);
          });
        },
        
        /**
         * 处理蓝牙数据
         * 解析从蓝牙设备接收到的原始数据并发送到后端
         * @param {DataView} value - 从蓝牙设备接收到的原始数据
         */
        handleBluetoothData: function(value) {
          // 解析蓝牙数据并发送到后端
          // 这里需要根据实际设备的数据格式进行解析
          let eegData = {
            type: 'eeg_data',
            timestamp: new Date().toISOString(),
            data: {
              Delta: value.getUint8(0),
              Theta: value.getUint8(1),
              Alpha: value.getUint8(2),
              Beta: value.getUint8(3),
              Gamma: value.getUint8(4)
            }
          };
          
          // 发送解析后的数据到后端
          if (this.isConnected && this.websocket) {
            try {
              this.websocket.send(JSON.stringify(eegData));
              this.dataStatus = '正在记录数据...';
            } catch (error) {
              this.$message.error('发送数据失败: ' + error.message);
            }
          }
        },
        
        /**
         * 测试API密钥
         * 验证用户输入的API密钥是否有效
         */
        testAPI: function() {
          // 检查API密钥是否已输入
          if (!this.apiKey) {
            this.$message.warning('请输入API密钥');
            return;
          }
          
          // 显示加载指示器
          const loading = this.$loading({
            lock: true,
            text: '测试中...',
            spinner: 'el-icon-loading',
            background: 'rgba(0, 0, 0, 0.7)'
          });
          
          // 发送测试请求到后端
          fetch('/api/test-api-key/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              api_key: this.apiKey
            })
          })
          .then(response => response.json())
          .then(data => {
            loading.close();
            if (data.status === 'success') {
              this.$message.success(data.message);
            } else {
              this.$message.error(data.message);
            }
          })
          .catch(error => {
            loading.close();
            this.$message.error('测试请求失败: ' + error.message);
          });
        },
        
        /**
         * 清空日志
         * 清除系统日志显示内容
         */
        clearLog: function() {
          this.logContent = '';
          this.$message.success('日志已清空');
        },
        /**
         * 处理WebSocket消息
         * 根据消息类型处理从后端接收到的消息
         * @param {Object} data - 从后端接收到的消息数据
         */
        handleWebSocketMessage: function(data) {
          switch (data.type) {
            case 'data_received':
              this.logContent += `[${new Date().toLocaleTimeString()}] 数据已接收: ${data.timestamp}\n`;
              break;
              
            case 'data_error':
              this.$message.error('数据处理错误: ' + data.error);
              this.logContent += `[${new Date().toLocaleTimeString()}] 错误: ${data.error}\n`;
              break;
              
            case 'import_success':
              this.$message.success('导入数据已成功保存到服务器');
              this.logContent += `[${new Date().toLocaleTimeString()}] 导入数据已保存: ${data.file_path}\n`;
              break;
              
            case 'analysis_result':
              if (data.success) {
                // 处理分析成功的返回结果
                // 使用loadReport函数加载和显示报告
                if (data.path) {
                  this.loadReport(data.path);
                } else if (data.content) {
                  // 如果直接返回了内容，则直接显示
                  this.reportContent = data.content;
                  this.activeTab = 'report';
                }
                this.$message.success('分析完成');
                this.logContent += `[${new Date().toLocaleTimeString()}] 分析完成\n`;
              } else {
                // 处理分析失败的情况
                this.$message.error('分析失败: ' + data.error);
                this.logContent += `[${new Date().toLocaleTimeString()}] 分析失败: ${data.error}\n`;
              }
              break;
              
            case 'error':
              this.$message.error('服务器错误: ' + data.message);
              this.logContent += `[${new Date().toLocaleTimeString()}] 服务器错误: ${data.message}\n`;
              break;
          }
          
          // 滚动到日志底部
          this.$nextTick(() => {
            const logPanel = document.querySelector('.el-tab-pane[name="log"] .placeholder');
            if (logPanel) {
              logPanel.scrollTop = logPanel.scrollHeight;
            }
          });
        }
      
      },
      watch: {
        isRecording: function(newVal) {
          this.dataStatus = newVal ? '正在记录数据...' : '未保存数据';
        }
      },
      
      mounted: function() {
        this.testBackend();
      }
    });
  </script>
  {% endverbatim %}
</body>
</html  >